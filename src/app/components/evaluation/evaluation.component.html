<h2 class="d-flex justify-content-center text-capitalize text-primary">{{ 'Evaluation' | translate }}</h2>
<hr style="margin-bottom: 20px;">

<div class="container-fluid ">


    <div class="row mt-2">
       
      
            <p-splitter [panelSizes]="[50, 30, 20]" [style]="{ height: '300px' }" styleClass="mb-5">
                <ng-template pTemplate>
                    <div class="col flex align-items-center justify-content-center">
                        <div class="row mt-1">
                            <p-toolbar>
                                <ng-template pTemplate="left">
                                    <button *ngIf="selectedQuestion.questionProtocoleID" type="button" pButton pRipple icon="pi pi-plus" (click)="openNoteDialog()" label="{{'Notation'| translate }}"
                                        class="p-button-primary" pTooltip="{{'Ajouter'| translate }}" tooltipPosition="bottom"></button>
                                </ng-template>
                                <ng-template pTemplate="right">
                                    <span class="p-input-icon-left">
                                        <i class="pi pi-search"></i>
                                        <input type="text" pInputText size="50" placeholder="{{ 'Rechercher' | translate }}"
                                            (input)="cr.filterGlobal($any($event.target).value, 'contains')">
                                    </span>
                                </ng-template>
                            </p-toolbar>
                            <p-table #cr [value]="questions" [globalFilterFields]="['titre','numero']"
                                styleClass="p-datatable-sm p-datatable-gridlines " sortField="numero"
                                (onRowSelect)="onRowSelect($event)" (onRowUnselect)="onRowUnselect($event)"
                                selectionMode="single" [(selection)]="selectedQuestion" dataKey="questionProtocoleID">
                                <ng-template pTemplate="header">
                                    <tr class="petit">
                                        <th pSortableColumn="numero">{{ 'PQ N' | translate }} <p-sortIcon
                                                field="numero">
                                            </p-sortIcon> </th>
                                        <th pSortableColumn="titre"> {{ 'titre' | translate }} <p-sortIcon
                                                field="titre">
                                            </p-sortIcon> </th>
                                        <th pSortableColumn="referenceoaciID" class="tres-petit">{{ 'REF OACI' | translate }} </th>
                                        <th pSortableColumn="elementCrutialCode" class="tres-petit">{{ 'EC' | translate }} </th>
                                        <!-- <th colspan="2"></th> -->
                                    </tr>
                                </ng-template>

                                <ng-template pTemplate="body" let-item let-i="rowIndex" let-rowspan="rowspan">
                                    <tr [pSelectableRow]="item" class="petit">


                                        <td class="fw-bold" colspan="1"> {{item.numero}} </td>
                                        <td > {{item.titre}} </td>
                                        <td class="tres-petit"> {{item.referenceoaciID}} </td>
                                        <td class="tres-petit"> {{item.elementCrutialCode}} </td>

                                        <!-- <td colspan="2">
                                    <div class="d-flex justify-content-end">
                                        <i class="pi  btn btn-sm  mx-2" (click)="openDialog(item)"
                                            pTooltip="{{item.contratObjectifID ? 'modifier' : 'nouveau' | translate }}"
                                            tooltipPosition="bottom"
                                            [ngClass]="item.contratObjectifID ? 'pi-pencil btn-success': 'pi-plus btn-primary'"></i>
                                        <i *ngIf="item.contratObjectifID" class="pi pi-print btn btn-sm btn-secondary mx-2"
                                            (click)="contratReport(item)" pTooltip="{{ 'Imprimer' | translate }}"
                                            tooltipPosition="bottom"></i>
            
                                        <i *ngIf="item.contratObjectifID" class="pi pi-trash btn btn-sm btn-danger"
                                            (click)="confirm(item)" pTooltip="{{ 'Supprimer' | translate }}"
                                            tooltipPosition="bottom"></i>
                                    </div>
                                </td> -->
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="emptymessage" let-item>
                                    <tr>
                                        <td [attr.colspan]="4">
                                            {{ 'Aucun Enregistrement trouvé' | translate }}
                                        </td>
                                    </tr>
                                </ng-template>
                            </p-table>

                        </div>
                    </div>
                </ng-template>
                <ng-template pTemplate>
                    <div class="col flex align-items-center justify-content-center">
                        <p-toolbar aria-label="Actions">
                            {{ 'Reponses' | translate }}
                        </p-toolbar>
                        <p-accordion class="w-full" *ngFor="let just of justificatifs ; let i=index;">
                            <p-accordionTab>
                                <ng-template pTemplate="header">
                                    <div class="flex align-items-center">
                                        <span class="vertical-align-middle petit">{{just.titre}}</span>
                                    </div>
                                </ng-template>
                                <ng-template pTemplate="content">
                                    <p class="m-0 petit">
                                        {{just.description}}
                                    </p>
                                </ng-template>
                            </p-accordionTab>
                        </p-accordion>
                    </div>
                </ng-template>
                <ng-template pTemplate>
                    <div class="col flex align-items-center justify-content-center bg-light">
                        <p-toolbar aria-label="Actions"> {{ 'Fichiers' | translate }} </p-toolbar>
                        <div class="card ">
                            <div class="card-body">
                                <ul class="list-group list-group-flush" *ngFor="let file of filesAll ; let i=index;">
                                    <li class="list-group-item ">
                                        <div class="row">
                                            <div class="col-10"><p class="petit"> {{ file.oldname }} </p></div>
                                            <div class="col-2"><i class="pi pi-download btn btn-sm btn-info mx-2" pTooltip="{{ 'telecharger' | translate }}" aria-label="telecharger"
                                                tooltipPosition="bottom" (click)="telecharger(file.id)"></i></div>
                                        </div>
                                        <!-- <p class="petit"> {{ file.oldname }} </p> -->
                                        
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </ng-template>
            </p-splitter>
    </div>
</div>

<!-- --------- -- --------- -- --------- -- --------- -- --------- -- --------- -- --------- -- --------- -->

<!--------------------  --------------------  --------------------  --------------------  --------------------  --------------------  --------------------  --------------------  --------------------  -->

<p-dialog header="Justificatif" [modal]="true" [(visible)]="displayadd" [style]="{'width':'60%','height':'90vh'}">

    <div class="container">


        <div class="row mb-2">
            <label for="phase" class="col-sm-6 col-md-2 col-lg-2 col-xl-2">
                {{'titre' | translate}}</label>
            <div class="col-sm-6 col-md-10 col-lg-10 col-xl-10">
                <input [(ngModel)]="justificatif.titre" type="text" name="ref" class="form-control" />
            </div>
        </div>

        <div class="row mb-2">
            <div class="col-sm-6 col-md-2 col-lg-2 col-xl-2">
                <label for="inputtext">{{ 'reponse' | translate }}</label>
            </div>
            <div class="col-sm-6 col-md-10 col-lg-10 col-xl-10">
                <!-- <p-editor [(ngModel)]="question.description" [style]="{ height: '50vh' }"></p-editor> -->
                <textarea [(ngModel)]="justificatif.description" name="reponse" class="form-control"
                    rows="8"></textarea>
            </div>
        </div>

        <div class="row mb-2">

            <div class="card mt-3">
                <div class="card-header">
                    <div class="row">
                        <div class="col-3">
                            {{'liste de fichiers'| translate}}
                        </div>
                        <div class="col-3">
                            <p-fileUpload [files]="fichiers" [maxFileSize]="500000000" [customUpload]="true"
                                mode="basic" name="myfile[]" (onSelect)="onUpload($event)" [multiple]="true"
                                type="application/pdf"
                                accept="image/*,.xlsx,.xls,.doc, .docx,.ppt,.pptx,.txt,application/pdf">
                            </p-fileUpload>
                        </div>
                    </div>
                    <div class="row mt-1">
                        <div class="progress my-3" *ngIf="currentFile">
                            <div class="progress-bar progress-bar-info progress-bar-striped" role="progressbar"
                                attr.aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100"
                                [ngStyle]="{ width: progress + '%' }">
                                {{ progress }}%
                            </div>
                        </div>
                    </div>

                </div>
                <div class="card-body">

                    <ul class="list-group list-group-flush" *ngFor="let file of files ; let i=index;">
                        <li class="list-group-item d-inline-flex">

                            <!-- <input pInputText class="form-control form-control-sm" type="text" name="input{{i}}"
                                [(ngModel)]="file.name" (ngModelChange)="isModified=true" placeholder="Name is required"
                                [style]="{width:'250px',height:'35px'}"
                                [ngClass]="file.name ? ' is-valid' : 'is-invalid'" /> -->


                            <a *ngIf="file.oldname" type="button" class="petit" href="{{ file.url }}">
                                 {{ file.oldname }} - {{ file.size }} </a>

                            <i class="pi pi-download btn btn-sm btn-info mx-2" pTooltip="{{ 'afficher' | translate }}"
                                aria-label="telecharger" tooltipPosition="bottom" (click)="telecharger(file.id)"></i>

                            <i class="pi pi-times btn btn-danger btn-sm mx-2"
                                pTooltip="{{'Supprimer' | translate }}"></i>
                            <!-- 
                            <button pButton pRipple type="button" icon="pi pi-check"
                                class="p-button-rounded p-button-text p-button-success mr-2"></button> -->


                        </li>
                    </ul>
                </div>

            </div>
        </div>

        <!-- --------- --  -->
    </div>

    <ng-template pTemplate="footer">
        <div class="d-flex justify-content-end">
            <button class="btn btn-success btn-sm mx-2" (click)="justificatifInsert()"> {{ 'enregistrer' | translate}}
            </button>
            <button class="btn btn-secondary btn-sm" (click)="closeAdd()"> {{ 'Fermer' | translate}} </button>
        </div>
    </ng-template>
</p-dialog>

<!--------------------  
    --------------------  --------------------  --------------------  --------------------  
    --------------------  --------------------  --------------------  --------------------  -->

<p-dialog [(visible)]="notationDialog" header="Attribuer une note" [modal]="true" [style]="{ width: '50vw',  height: '50vh' }"
    [draggable]="false" [resizable]="false">
    <div class="modal-body">
        <div class="row mt-4">
            <label for="phase" class="col-sm-6 col-md-2 col-lg-2 col-xl-2">
                {{'Note' | translate}}</label>
            <div class="col-sm-6 col-md-10 col-lg-10 col-xl-10">
                <p-dropdown [(ngModel)]="selectedQuestion.noteID" [style]="{width:'80%',height:'35px'}"
                    placeholder="  " [showClear]="true" [options]="notations" optionLabel="libelle" optionValue="noteID"
                    [filter]="true" filterBy="libelle" [showClear]="true">

                    <ng-template let-act pTemplate="item">
                        <div class="activite-item">
                            <div>
                                {{act.code}} - {{act.libelle}}
                            </div>
                        </div>
                    </ng-template>
                </p-dropdown>
            </div>
        </div>

    </div>
    <ng-template pTemplate="footer">
        <p-button styleClass="p-button-outlined" (click)="hideDialog()">
            <!-- <mat-icon>cancel</mat-icon> -->&nbsp;Annuler</p-button>&nbsp;&nbsp; <p-button
            styleClass="p-button-raised p-button-success" (click)="saveNote()" *ngIf="selectedQuestion.noteID">
            <!--  <mat-icon>save</mat-icon> -->&nbsp;Enregistrer </p-button> </ng-template>
</p-dialog>

<!--------------------  
    --------------------  --------------------  --------------------  --------------------  
    --------------------  --------------------  --------------------  --------------------  -->


<!-- dialog succès -->
<p-dialog header="{{ 'Succes' | translate }}" [modal]="true" [(visible)]="displaySucces" [style]="{'width':'30%'}">
    <div class="container">
        <div class="row">
            <div class="card-body">
                <h6 class="text-success">
                    {{successMessage | translate}}
                </h6>
                <div class="card-footer d-flex justify-content-end">
                    <button class="btn btn-sm btn-primary" (click)="closeSucces()">OK</button>
                </div>
            </div>
        </div>
    </div>
</p-dialog>


<!-- dialog erreur -->
<p-dialog header="{{ 'Erreur' | translate }}" [modal]="true" [(visible)]="displayError" [style]="{'width':'30%'}">
    <div class="container">
        <div class="row">
            <div class="col">
                <div class="card-body">
                    <h6 class="text-danger">
                        {{errorMessage| translate}}
                    </h6>
                    <div class="card-footer d-flex justify-content-end">
                        <button class="btn btn-sm btn-primary" (click)="closeError()">OK</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</p-dialog>





<!-- SPINNER DE CHARGEMENT DU TREETABLE -->
<div class="progress-spinner" *ngIf="displaySpinner" modal="true" style="z-index: 9999;">
    <div class="d-flex justify-content-center">
        <p-progressSpinner styleClass="custom-spinner" strokeWidth="4" animationDuration="2.5s"></p-progressSpinner>
    </div>
    <div class="d-flex justify-content-center affiche">
        <h6 style="color: rgb(255, 255, 255);z-index: 999;">Generation du fichier...</h6>
    </div>
</div>

<p-confirmDialog header="Confirmation"></p-confirmDialog>